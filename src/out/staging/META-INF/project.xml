<exportedData version="69" buildLabel="build_main_89270_2015.04.16_07:48:51" buildVersion="5.4.0.89270" passkey="5988fd40f08f691b7b3605f17301cfc761659b8f">
  <exportPath>/projects/EC-Support</exportPath>
  <project>
    <projectName>EC-Support</projectName>
    <description>Interaction with Support</description>
    <resourceName />
    <tracked>0</tracked>
    <workspaceName />
    <propertySheet>
      <tracked>0</tracked>
      <property>
        <propertyName>ec_visibility</propertyName>
        <counter>0</counter>
        <expandable>1</expandable>
        <tracked>0</tracked>
        <value>pickListOnly</value>
      </property>
      <property>
        <propertyName>help</propertyName>
        <counter>0</counter>
        <description>The help page for EC-Support</description>
        <expandable>1</expandable>
        <tracked>0</tracked>
        <value>&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

&lt;html xmlns="http://www.w3.org/1999/xhtml">
&lt;head>
    &lt;meta content="text/html; charset=us-ascii" http-equiv="content-type" />
    &lt;title>EC-Support Plugin&lt;/title>
    &lt;link rel="stylesheet" href= "../../plugins/EC-Support-1.1.0.36/pluginhelp.css" type="text/css" media= "screen" />
&lt;/head>

&lt;body>
    &lt;div class="help">
        &lt;h1>EC-Support&lt;/h1>
		&lt;p>Plugin Version 1.1.0.36&lt;/p>
        &lt;hr style="margin-left: -10px; margin-top: 10px; height: 1px; width: 100%; color: #5981BD;" noshade="noshade" />

        &lt;p>EC-Support is a collection of procedures to help you interact with Electric Cloud support. It requires both 
        &lt;a href="/commander/pages/EC-Zendesk/help">EC-Zendesk&lt;/a> and 
        &lt;a href="/commander/pages/EC-ShareFile/help">EC-ShareFile&lt;/a> plugins.&lt;/p>

		&lt;p>&lt;b>Note:&lt;/b> this plugin was part of the bundle who helped Laurent Rochette and Nikhil Vaze won "Best in Show" at the Citrix Synergy 2015 conference.&lt;/p>

		&lt;h1>Plugin Procedures&lt;/h1>

	    &lt;p>
	        IMPORTANT: For all parameter descriptions below, required
	        parameters are shown in &lt;span class="required">bold
	        italics&lt;/span>.
	    &lt;/p>
    
    	&lt;h2>openSupportTicket&lt;/h2>

        &lt;p>This procedure is the workhorse of this plugin, it opens a ticket on Zendesk, gather the required logs and upload them on ShareFile automatically.
    	&lt;/p>

	    &lt;table class="grid">
	        &lt;thead>
	            &lt;tr>
	                &lt;th>Parameter&lt;/th>

	                &lt;th>Description&lt;/th>
	            &lt;/tr>
	        &lt;/thead>

	        &lt;tbody>
	            &lt;tr>
	                &lt;td class="required">Title&lt;/td>
	                &lt;td>The subject of your ticket.&lt;/td>
	            &lt;/tr>
	            &lt;tr>
	                &lt;td class="required">Description&lt;/td>
	                &lt;td>The complete description of your ticket. Be as specific as possible.&lt;/td>
	            &lt;/tr>
	            &lt;tr>
	                &lt;td class="required">Product&lt;/td>
	                &lt;td>ElectricFlow or ElectricCommander&lt;/td>
	            &lt;/tr>
	           &lt;tr>
	                &lt;td class="required">Server Resources&lt;/td>
	                &lt;td>The resource associated to your server (default: local). If you have a clustered configuration, enter a comma separated list of agents or a pool.&lt;/td>
	            &lt;/tr>
           		&lt;tr>
	                &lt;td class="required">Zendesk Configuration&lt;/td>
	                &lt;td>The configuration in the &lt;a href="/commander/pages/EC-Zendesk/help">EC-Zendesk plugin&lt;/a> that contain login/password to connect to Zendesk and open a ticket.&lt;/td>
	            &lt;/tr>
           		&lt;tr>
	                &lt;td class="required">ShareFile Configuration&lt;/td>
	                &lt;td>The configuration in the &lt;a href="/commander/pages/EC-ShareFile/help">EC-ShareFile plugin&lt;/a> that contain login/password to connect to ShareFile to upload the logs.&lt;/td>
	            &lt;/tr>
           		&lt;tr>
	                &lt;td class="required">ShareFile Upload Directory&lt;/td>
	                &lt;td>Your company directory on ShareFile where to upload the logs files. The directory is usually something like /clients/X-Z/NAME/uploads. Check on ShareFile if you are unsure.&lt;/td>
	            &lt;/tr>
           		&lt;tr>
	                &lt;td>Agent List&lt;/td>
	                &lt;td>This optional parameter allows to  pass a list of agents -comma separated- for which the logs will be gathered and uploaded automatically.&lt;/td>
	            &lt;/tr>		        
           		&lt;tr>
	                &lt;td>Time&lt;/td>
	                &lt;td>If this optional parameter is set, all the commander logs from that time on will be gathered from all servers and uploaded automatically.&lt;/td>
	            &lt;/tr>		        
           		&lt;tr>
	                &lt;td>Job Id&lt;/td>
	                &lt;td>If this optional parameter is set, all the commander logs containing this jobId will be gathered from all servers and uploaded automatically.&lt;/td>
	            &lt;/tr>		        
	        &lt;/tbody>
    	&lt;/table>
    	&lt;img src="../../plugins/EC-Support/images/help/openSupportTicket.png" alt="form" border="1"/>

	&lt;/div>
&lt;/body>
&lt;/html></value>
      </property>
      <property>
        <propertyName>pluginBuildNumber</propertyName>
        <counter>0</counter>
        <description />
        <expandable>1</expandable>
        <tracked>0</tracked>
        <value>36</value>
      </property>
      <property>
        <propertyName>pluginDependencies</propertyName>
        <counter>0</counter>
        <description>Minimum version of required plugins

</description>
        <expandable>1</expandable>
        <tracked>0</tracked>
        <value>EC-Zendesk:    1.2.2
EC-ShareFile  :1.1.1
</value>
      </property>
      <property>
        <propertyName>version</propertyName>
        <counter>0</counter>
        <description>Changelog for EC-Support plugin

History:
- version 1.1.0
  + Fix  #8: added openEnhancementRequest procedure

- version 1.0.0
  + original version</description>
        <expandable>1</expandable>
        <tracked>0</tracked>
        <value>1.1.0</value>
      </property>
    <property><propertyName>ec_setup</propertyName><value># Data that drives the create step picker registration for this plugin.
@::createStepPickerSteps = ();
</value><expandable>0</expandable></property><property><propertyName>project_version</propertyName><value>1.1.0.36</value></property></propertySheet>
    <procedure>
      <procedureName>collectServerLogs</procedureName>
      <description>a procedure to collect server logs</description>
      <jobNameTemplate />
      <resourceName />
      <timeLimit />
      <timeLimitUnits>minutes</timeLimitUnits>
      <tracked>0</tracked>
      <workspaceName />
      <propertySheet>
        <tracked>0</tracked>
        <property>
          <propertyName>ec_customEditorData</propertyName>
          <tracked>0</tracked>
          <propertySheet>
            <tracked>0</tracked>
            <property>
              <propertyName>parameters</propertyName>
              <tracked>0</tracked>
              <propertySheet>
                <tracked>0</tracked>
                <property>
                  <propertyName>destinationDirectory</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>jobNumber</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>serverResources</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>time</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
              </propertySheet>
            </property>
          </propertySheet>
        </property>
      </propertySheet>
      <formalParameter>
        <formalParameterName>destinationDirectory</formalParameterName>
        <defaultValue />
        <description>The directory in which to copy the logs.</description>
        <expansionDeferred>0</expansionDeferred>
        <required>0</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>jobNumber</formalParameterName>
        <defaultValue />
        <description>The ID of the job that generated the error. Will be used to collect the right logs</description>
        <expansionDeferred>0</expansionDeferred>
        <required>0</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>serverResources</formalParameterName>
        <defaultValue />
        <description>A list of resources or pools, comma separated</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>time</formalParameterName>
        <defaultValue />
        <description>The time at which the issue happened. Used to collect the right logs.</description>
        <expansionDeferred>0</expansionDeferred>
        <required>0</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <step>
        <stepName>loop</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>$[/plugins[EC-Admin]/project/scripts/perlHeaderJSON]

#
# Parameters
#
my $serverResources = "$[serverResources]";

#
# global variables
#
my $targetServerResource="$[/myJobStep/assignedResourceName]";
my %resourceHash=();

#
# Parse the list of servers
foreach my $server (split(",", $serverResources)) {
	$server =~ s/^\s*//;	# removing leading  spaces
    $server =~ s/\s*$//;	# removing trailing spaces
    
	#
	# Is this a pool?
	my ($ok, $json)=InvokeCommander("IgnoreError SuppressLog", 'getResourcePool', $server);
    if ($ok) {
    	printf("Processing pool   $server\n");
        foreach my $node($ec->getResourcesInPool($server)->findnodes("//resource")) {
        	my $resName=$node->{resourceName};
            printf("    processing server $resName\n");
            $resourceHash{$resName}=1;
        } 
        next;
    }
    
    #
    # Check if it's a valid resource
	my ($ok, $json)=InvokeCommander("IgnoreError SuppressLog", 'getResource', $server);
    if ($ok) {
    	printf("Processing server $server\n");
        $resourceHash{$server}=1;
    } else {
    	printf("$server is not a recognized pool or resource\n");
        exit(1);
    }
}

printf("\n");
foreach my $server (keys %resourceHash) {
	printf("Collecting logs for %s\n", $server);
	my ($ok, $json)=InvokeCommander("IgnoreError", 'getResource', $server);
    my $node=$json->{responses}->[0]->{resource};
    my $resName=$node->{resourceName};
    
    if (($node->{resourceDisabled} == 0) &amp;&amp; ($node->{agentState}->{alive} == 1) ) {
    	$ec->createJobStep({
              subprocedure=>"sub-collectServerLogs",
              jobStepName => "collect-$resName",
              actualParameter => [
                {actualParameterName => "serverResource",       value => $resName},
                {actualParameterName => "destinationDirectory", value => "$[destinationDirectory]"},
                {actualParameterName => "targetServerResource", value => "$targetServerResource"},
              ]});

    }
}

$[/plugins[EC-Admin]/project/scripts/perlLibJSON]
</command>
        <condition />
        <description />
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <logFileName />
        <parallel>0</parallel>
        <postProcessor />
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <shell>ec-perl</shell>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workingDirectory />
        <workspaceName />
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
    </procedure>
    <procedure>
      <procedureName>openEnhancementRequest</procedureName>
      <description>A procedure to automatically open an enhancement request on Zendesk.
No log involved</description>
      <jobNameTemplate />
      <resourceName>local</resourceName>
      <timeLimit />
      <timeLimitUnits>minutes</timeLimitUnits>
      <tracked>0</tracked>
      <workspaceName />
      <propertySheet>
        <tracked>0</tracked>
        <property>
          <propertyName>ec_customEditorData</propertyName>
          <tracked>0</tracked>
          <propertySheet>
            <tracked>0</tracked>
            <property>
              <propertyName>parameters</propertyName>
              <tracked>0</tracked>
              <propertySheet>
                <tracked>0</tracked>
                <property>
                  <propertyName>ShareFileCredentialName</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>agents</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>jobNumber</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>product</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>options</propertyName>
                      <tracked>0</tracked>
                      <propertySheet>
                        <tracked>0</tracked>
                        <property>
                          <propertyName>option1</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>ElectricCommander</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>electriccommander</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option2</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>ElectricFlow</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>electricflow</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>optionCount</propertyName>
                          <counter>0</counter>
                          <expandable>1</expandable>
                          <tracked>0</tracked>
                          <value>2</value>
                        </property>
                        <property>
                          <propertyName>type</propertyName>
                          <counter>0</counter>
                          <expandable>1</expandable>
                          <tracked>0</tracked>
                          <value>list</value>
                        </property>
                      </propertySheet>
                    </property>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>serverResources</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>sharefileConfiguration</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>sharefileUploadDirectory</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>stepId</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketDescription</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketTitle</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>time</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>version</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>zendeskConfiguration</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>zendeskCredential</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
              </propertySheet>
            </property>
          </propertySheet>
        </property>
        <property>
          <propertyName>ec_parameterForm</propertyName>
          <counter>0</counter>
          <description />
          <expandable>1</expandable>
          <tracked>0</tracked>
          <value>&lt;editor>
    &lt;formElement> 
        &lt;label>Title&lt;/label> 
        &lt;property>ticketTitle&lt;/property> 
        &lt;documentation>The title of your ticket.&lt;/documentation> 
        &lt;type>entry&lt;/type>
        &lt;value>Enhancement Request: &lt;/value>
        &lt;required>1&lt;/required>
    &lt;/formElement> 

    &lt;formElement> 
        &lt;label>Description&lt;/label> 
        &lt;property>ticketDescription&lt;/property> 
        &lt;documentation>The full description of your ticket.&lt;/documentation> 
        &lt;type>textarea&lt;/type>
        &lt;required>1&lt;/required>
    &lt;/formElement> 

    &lt;formElement> 
        &lt;label>Product&lt;/label> 
        &lt;property>product&lt;/property> 
        &lt;documentation>The name of the product with which you have an issue.&lt;/documentation> 
        &lt;type>select&lt;/type> 
        &lt;option> 
            &lt;name>ElectricCommander&lt;/name> 
            &lt;value>electriccommander&lt;/value> 
        &lt;/option> 
        &lt;option> 
            &lt;name>ElectricFlow&lt;/name> 
            &lt;value>electricflow&lt;/value> 
        &lt;/option> 
        &lt;value>electriccommander&lt;/value> 
        &lt;required>1&lt;/required>
    &lt;/formElement> 

    &lt;formElement> 
        &lt;label>Zendesk configuration&lt;/label> 
        &lt;property>zendeskConfiguration&lt;/property> 
        &lt;documentation>The name of the Zendesk configuration to use.&lt;/documentation> 
        &lt;type>entry&lt;/type>
        &lt;value>zendesk&lt;/value>
        &lt;required>1&lt;/required>
    &lt;/formElement> 
&lt;/editor>
</value>
        </property>
      </propertySheet>
      <formalParameter>
        <formalParameterName>product</formalParameterName>
        <defaultValue>electricflow</defaultValue>
        <description>the name of the product that failed</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>select</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>ticketDescription</formalParameterName>
        <defaultValue />
        <description>The main description of the issue you are facing</description>
        <expansionDeferred>0</expansionDeferred>
        <required>0</required>
        <tracked>0</tracked>
        <type>textarea</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>ticketTitle</formalParameterName>
        <defaultValue>Enhancement Request: </defaultValue>
        <description />
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>zendeskConfiguration</formalParameterName>
        <defaultValue>zendesk</defaultValue>
        <description>The name of your Zendesk configuration</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <step>
        <stepName>getVersion</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>$[/plugins[EC-Admin]project/scripts/perlHeaderJSON]

my ($ok, $json)=InvokeCommander("", 'getVersions');

if ($ok) {
	my $version=$json->{responses}->[0]->{serverVersion}->{version};

	$ec->setProperty ("/myJob/serverVersion", $version);
	$ec->setProperty ("summary", "Server version: $version");
} else {
	$ec->setProperty ("/myJob/serverVersion", "");
	$ec->setProperty ("summary", "Cannot retrive server version");
	$ec->setProperty ("outcome", "warning");
	
}    
$[/plugins[EC-Admin]project/scripts/perlLibJSON]
</command>
        <condition />
        <description>Retrieve the server version</description>
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <logFileName />
        <parallel>0</parallel>
        <postProcessor />
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <shell>ec-perl</shell>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workingDirectory />
        <workspaceName />
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
      <step>
        <stepName>createTicket</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <condition />
        <description>Open the ticket</description>
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <parallel>0</parallel>
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <subprocedure>createTicket</subprocedure>
        <subproject>/plugins/EC-Zendesk/project</subproject>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workspaceName />
        <actualParameters>
          <tracked>0</tracked>
          <property>
            <propertyName>credential</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[zendeskConfiguration]</value>
          </property>
          <property>
            <propertyName>product</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[product]</value>
          </property>
          <property>
            <propertyName>ticketDescription</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[ticketDescription]</value>
          </property>
          <property>
            <propertyName>ticketSubject</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[ticketTitle]</value>
          </property>
          <property>
            <propertyName>version</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[serverVersion]</value>
          </property>
        </actualParameters>
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
    </procedure>
    <procedure>
      <procedureName>openSupportTicket</procedureName>
      <description>A procedure to automatically open a ticket on Zendesk and deliver the required logs to ShareFile</description>
      <jobNameTemplate />
      <resourceName>local</resourceName>
      <timeLimit />
      <timeLimitUnits>minutes</timeLimitUnits>
      <tracked>0</tracked>
      <workspaceName />
      <propertySheet>
        <tracked>0</tracked>
        <property>
          <propertyName>ec_customEditorData</propertyName>
          <tracked>0</tracked>
          <propertySheet>
            <tracked>0</tracked>
            <property>
              <propertyName>parameters</propertyName>
              <tracked>0</tracked>
              <propertySheet>
                <tracked>0</tracked>
                <property>
                  <propertyName>ShareFileCredentialName</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>agents</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>jobNumber</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>product</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>options</propertyName>
                      <tracked>0</tracked>
                      <propertySheet>
                        <tracked>0</tracked>
                        <property>
                          <propertyName>option1</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>ElectricCommander</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>electriccommander</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option2</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>ElectricFlow</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>electricflow</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>optionCount</propertyName>
                          <counter>0</counter>
                          <expandable>1</expandable>
                          <tracked>0</tracked>
                          <value>2</value>
                        </property>
                        <property>
                          <propertyName>type</propertyName>
                          <counter>0</counter>
                          <expandable>1</expandable>
                          <tracked>0</tracked>
                          <value>list</value>
                        </property>
                      </propertySheet>
                    </property>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>serverResources</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>sharefileConfiguration</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>sharefileUploadDirectory</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>stepId</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketDescription</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketTitle</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>time</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>version</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>zendeskConfiguration</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>zendeskCredential</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
              </propertySheet>
            </property>
          </propertySheet>
        </property>
        <property>
          <propertyName>ec_parameterForm</propertyName>
          <counter>0</counter>
          <description />
          <expandable>1</expandable>
          <tracked>0</tracked>
          <value>&lt;editor>
    &lt;formElement> 
        &lt;label>Title&lt;/label> 
        &lt;property>ticketTitle&lt;/property> 
        &lt;documentation>The title of your ticket.&lt;/documentation> 
        &lt;type>entry&lt;/type>
        &lt;required>1&lt;/required>
    &lt;/formElement> 

    &lt;formElement> 
        &lt;label>Description&lt;/label> 
        &lt;property>ticketDescription&lt;/property> 
        &lt;documentation>The full description of your ticket.&lt;/documentation> 
        &lt;type>textarea&lt;/type>
        &lt;required>1&lt;/required>
    &lt;/formElement> 

    &lt;formElement> 
        &lt;label>Product&lt;/label> 
        &lt;property>product&lt;/property> 
        &lt;documentation>The name of the product with which you have an issue.&lt;/documentation> 
        &lt;type>select&lt;/type> 
        &lt;option> 
            &lt;name>ElectricCommander&lt;/name> 
            &lt;value>electriccommander&lt;/value> 
        &lt;/option> 
        &lt;option> 
            &lt;name>ElectricFlow&lt;/name> 
            &lt;value>electricflow&lt;/value> 
        &lt;/option> 
        &lt;value>electriccommander&lt;/value> 
        &lt;required>1&lt;/required>
    &lt;/formElement> 

    &lt;formElement>
        &lt;label>Server Resources&lt;/label>
        &lt;property>serverResources&lt;/property>
         &lt;documentation>A list of resources -comma separated- or pools to represent your server list. Change the default value for cluster mode.&lt;/documentation> 
        &lt;type>entry&lt;/type>
        &lt;required>1&lt;/required>
        &lt;value>local&lt;/value>       
    &lt;/formElement> 

    &lt;formElement> 
        &lt;label>Zendesk configuration&lt;/label> 
        &lt;property>zendeskConfiguration&lt;/property> 
        &lt;documentation>The name of the Zendesk configuration to use.&lt;/documentation> 
        &lt;type>entry&lt;/type>
        &lt;value>zendesk&lt;/value>
        &lt;required>1&lt;/required>
    &lt;/formElement> 
    
    &lt;formElement> 
        &lt;label>ShareFile configuration&lt;/label> 
        &lt;property>sharefileConfiguration&lt;/property> 
        &lt;documentation>The name of the ShareFile configuration to use.&lt;/documentation> 
        &lt;type>entry&lt;/type>
        &lt;value>sharefile&lt;/value>
        &lt;required>1&lt;/required>
    &lt;/formElement> 

    &lt;formElement> 
        &lt;label>ShareFile upload directory&lt;/label> 
        &lt;property>sharefileUploadDirectory&lt;/property> 
        &lt;documentation>The path to your EC-ShareFile uploads directory.&lt;/documentation> 
        &lt;type>entry&lt;/type>
        &lt;value>/clients/X-Z/NAME/uploads&lt;/value>
        &lt;required>1&lt;/required>
    &lt;/formElement> 

    &lt;formElement> 
        &lt;label>Agent List&lt;/label> 
        &lt;property>agents&lt;/property> 
        &lt;documentation>The comma separated list of agents where the problem occured.&lt;/documentation> 
        &lt;type>entry&lt;/type>
    &lt;/formElement> 

    &lt;formElement> 
        &lt;label>Time&lt;/label> 
        &lt;property>time&lt;/property> 
        &lt;documentation>The time at which the issue happened (if known). Format is [yyyy-mm-dd] HH:mm.&lt;/documentation> 
        &lt;type>entry&lt;/type>
    &lt;/formElement> 

    &lt;formElement> 
        &lt;label>Job Id&lt;/label> 
        &lt;property>jobNumber&lt;/property> 
        &lt;documentation>The jobId in which the issue occured (if known). It is used to retrieve the correct logs.&lt;/documentation> 
        &lt;type>entry&lt;/type>
    &lt;/formElement> 

&lt;/editor>
</value>
        </property>
      </propertySheet>
      <formalParameter>
        <formalParameterName>agents</formalParameterName>
        <defaultValue />
        <description>a commas separated list of agents. Will be used to get the logs from the agents involved in the issue</description>
        <expansionDeferred>0</expansionDeferred>
        <required>0</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>jobNumber</formalParameterName>
        <defaultValue />
        <description>The ID of the job that generated the error. Will be used to collect the right logs</description>
        <expansionDeferred>0</expansionDeferred>
        <required>0</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>product</formalParameterName>
        <defaultValue>electricflow</defaultValue>
        <description>the name of the product that failed</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>select</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>serverResources</formalParameterName>
        <defaultValue>local</defaultValue>
        <description>A list of resources or pools, comma separated</description>
        <expansionDeferred>0</expansionDeferred>
        <required>0</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>sharefileConfiguration</formalParameterName>
        <defaultValue>sharefile</defaultValue>
        <description>Name of your Sharefile configuration</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>sharefileUploadDirectory</formalParameterName>
        <defaultValue />
        <description>Private directory on ShareFile on where to upload the logs</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>ticketDescription</formalParameterName>
        <defaultValue />
        <description>The main description of the issue you are facing</description>
        <expansionDeferred>0</expansionDeferred>
        <required>0</required>
        <tracked>0</tracked>
        <type>textarea</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>ticketTitle</formalParameterName>
        <defaultValue />
        <description />
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>time</formalParameterName>
        <defaultValue />
        <description>The time at which the issue happened. Used to collect the right logs. If empty, will simply send the commander.log</description>
        <expansionDeferred>0</expansionDeferred>
        <required>0</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>zendeskConfiguration</formalParameterName>
        <defaultValue>zendesk</defaultValue>
        <description>The name of your Zendesk configuration</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <step>
        <stepName>getVersion</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>$[/plugins[EC-Admin]project/scripts/perlHeaderJSON]

my ($ok, $json)=InvokeCommander("", 'getVersions');

if ($ok) {
	my $version=$json->{responses}->[0]->{serverVersion}->{version};

	$ec->setProperty ("/myJob/serverVersion", $version);
	$ec->setProperty ("summary", "Server version: $version");
} else {
	$ec->setProperty ("/myJob/serverVersion", "");
	$ec->setProperty ("summary", "Cannot retrive server version");
	$ec->setProperty ("outcome", "warning");
	
}    
$[/plugins[EC-Admin]project/scripts/perlLibJSON]
</command>
        <condition />
        <description>Retrieve the server version</description>
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <logFileName />
        <parallel>0</parallel>
        <postProcessor />
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <shell>ec-perl</shell>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workingDirectory />
        <workspaceName />
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
      <step>
        <stepName>grabResource</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>ectool setProperty /myJob/assignedServerResource --value $[/myJobStep/assignedResourceName]
</command>
        <condition />
        <description>Grab one of the commander server resources (in case of cluster)</description>
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <logFileName />
        <parallel>0</parallel>
        <postProcessor />
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <shell />
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workingDirectory />
        <workspaceName />
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
      <step>
        <stepName>createTicket</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <condition>$[/javascript
  if ( "$[/server/settings/ipAddress]" == "ec54" ) {
    setProperty("/myJob/zendesk/ticketId", "114520");
   setProperty("summary", "Debug mode: 114520");
   false;
  } else {
   true;
  } ]</condition>
        <description>Open the ticket</description>
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <parallel>0</parallel>
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <subprocedure>createTicket</subprocedure>
        <subproject>/plugins/EC-Zendesk/project</subproject>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workspaceName />
        <actualParameters>
          <tracked>0</tracked>
          <property>
            <propertyName>credential</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[zendeskConfiguration]</value>
          </property>
          <property>
            <propertyName>product</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[product]</value>
          </property>
          <property>
            <propertyName>ticketDescription</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[ticketDescription]</value>
          </property>
          <property>
            <propertyName>ticketSubject</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[ticketTitle]</value>
          </property>
          <property>
            <propertyName>version</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[/myJob/serverVersion]</value>
          </property>
        </actualParameters>
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
      <step>
        <stepName>grabDestinationDir</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>#############################################################################
#
# Copyright Electric-Cloud 2015
#
#############################################################################
use Cwd;

$[/plugins[EC-Admin]project/scripts/perlHeaderJSON]

#############################################################################
#
# Global Variables
#
#############################################################################
my $cwd = getcwd();

$ec->setProperty("/myJob/destinationDirectory", "$cwd/$[/myJob/zendesk/ticketId]");
</command>
        <condition />
        <description />
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <logFileName />
        <parallel>0</parallel>
        <postProcessor />
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <shell>ec-perl</shell>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workingDirectory />
        <workspaceName />
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
      <step>
        <stepName>createTicketDirectory</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <condition />
        <description>create a directory to collect the logs</description>
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <parallel>0</parallel>
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName>$[/myJob/assignedServerResource]</resourceName>
        <subprocedure>CreateDirectory</subprocedure>
        <subproject>/plugins/EC-FileOps/project</subproject>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workspaceName />
        <actualParameters>
          <tracked>0</tracked>
          <property>
            <propertyName>Path</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[/myJob/destinationDirectory]</value>
          </property>
        </actualParameters>
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
      <step>
        <stepName>collectServerLogs</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <condition />
        <description />
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <parallel>0</parallel>
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <subprocedure>collectServerLogs</subprocedure>
        <subproject />
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workspaceName />
        <actualParameters>
          <tracked>0</tracked>
          <property>
            <propertyName>destinationDirectory</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[/myJob/destinationDirectory]</value>
          </property>
          <property>
            <propertyName>jobNumber</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[jobNumber]</value>
          </property>
          <property>
            <propertyName>serverResources</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[serverResources]</value>
          </property>
          <property>
            <propertyName>time</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[time]</value>
          </property>
        </actualParameters>
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
      <step>
        <stepName>collectAgentLogs</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>#############################################################################
#
# Copyright Electric-Cloud 2015
#
#############################################################################
use Cwd;

$[/plugins[EC-Admin]project/scripts/perlHeaderJSON]

#############################################################################
#
# Parameters
#
#############################################################################
my $agentList = "$[agents]";

#############################################################################
#
# Global Variables
#
#############################################################################
my $DEBUG=1;
my $logDir="$[/server/Electric Cloud/dataDirectory]/logs";
my $cwd = getcwd();

foreach my $agent (sort split(",", $agentList)) {

	# Testing agent existence
    #
	my($ok, $json)=InvokeCommander("IgnoreError SuppressLog", 'getResource', $agent);
    if (! $ok) {
    	printf("Agent '%s' does not exist!", $agent);
        $ec->setProperty("outcome", "warning");
        next;
    }
    
    # Testing if agent is running
    #
    if ($json->{responses}->[0]->{resource}->{agentState}->{state} ne "alive") {
    	printf("Agent '%s' is not running!\n", $agent);
        $ec->setProperty("outcome", "warning");
        next;
    }
    if ($json->{responses}->[0]->{resource}->{resourceDisabled} eq "1") {
    	printf("Agent '%s' is disabled!\n", $agent);
        $ec->setProperty("outcome", "warning");
        next;
    }
    
	# run step on remote agent so we can get the installDir
    $ec->createJobStep({
        subproject   => "/plugins/EC-FileOps/project",
        subprocedure => "Remote Copy - Native",
        jobStepName  => "Copy $agent",
        resourceName => $agent,
        actualParameter => [
         	{actualParameterName => 'sourceWorkspaceName',      value => "default"},
          	{actualParameterName => 'sourceResourceName',       value => "$agent"},
            {actualParameterName => 'sourceFile',               value => $ENV{COMMANDER_DATA}."/logs/agent/*agent.log"},
          	{actualParameterName => 'destinationResourceName',  value => "local"},
           	{actualParameterName => 'destinationFile',          value => "$[/myJob/destinationDirectory]/$agent"},
           	{actualParameterName => 'destinationWorkspaceName', value => "default"},
           ],
    });
}

$[/plugins[EC-Admin]project/scripts/perlLibJSON]

</command>
        <condition>$[/javascript "$[agents]" != "" ]</condition>
        <description>If agent list is not empty, go grab agent.log and jagent.log</description>
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <logFileName />
        <parallel>0</parallel>
        <postProcessor />
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <shell>ec-perl</shell>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workingDirectory />
        <workspaceName />
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
      <step>
        <stepName>listing</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>#############################################################################
#
# Copyright Electric-Cloud 2015
#
#############################################################################
$[/plugins[EC-Admin]project/scripts/perlHeaderJSON]

#############################################################################
#
# Parameters
#
#############################################################################

#############################################################################
#
# Global Variables
#
#############################################################################
my $DEBUG=1;
my $destDir="$[/myJob/zendesk/ticketId]";


my $content=directoryContent($destDir);
$ec->setProperty("/myJob/fileList", $content);

#############################################################################
#
# directoryContent: return a string containing the list of files
#                   in a directory
#############################################################################
sub directoryContent {
    my $dir=shift @_;
    my $content="";
    
    opendir(my $dh, $dir) or die("Cannot open the directory $dir\n$!");

	while (my $file = readdir($dh)) {
    	next if $file eq '.' or $file eq '..';
    	if (-d "$dir/$file") {
    		$content .= directoryContent("$dir/$file");	
        } else {
        	$content .= "$dir/$file\n";
            printf("$dir/$file\n") if ($DEBUG);
        }
    }
    closedir($dh);
    return $content;
}
    
</command>
        <condition />
        <description>Get the list of collected files</description>
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <logFileName />
        <parallel>0</parallel>
        <postProcessor />
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName>$[/myJob/assignedServerResource]</resourceName>
        <shell>ec-perl</shell>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workingDirectory />
        <workspaceName />
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
      <step>
        <stepName>createBundle</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <condition />
        <description>Zip the different files</description>
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <parallel>0</parallel>
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <subprocedure>Create Zip File</subprocedure>
        <subproject>/plugins/EC-FileOps/project</subproject>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workspaceName />
        <actualParameters>
          <tracked>0</tracked>
          <property>
            <propertyName>sourceFile</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[/myJob/destinationDirectory]</value>
          </property>
          <property>
            <propertyName>zipFile</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[/myJob/destinationDirectory].zip</value>
          </property>
        </actualParameters>
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
      <step>
        <stepName>uploadBundleToSharefile</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <condition />
        <description />
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <parallel>0</parallel>
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <subprocedure>CreateFolderAndUploadFile</subprocedure>
        <subproject>/plugins/EC-ShareFile/project</subproject>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workspaceName />
        <actualParameters>
          <tracked>0</tracked>
          <property>
            <propertyName>company</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>Electric Cloud</value>
          </property>
          <property>
            <propertyName>config</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[ShareFileConfiguration]</value>
          </property>
          <property>
            <propertyName>folderToCreate</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[sharefileUploadDirectory]/$[/myJob/zendesk/ticketId]</value>
          </property>
          <property>
            <propertyName>pathToFile</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[/myJob/destinationDirectory].zip</value>
          </property>
        </actualParameters>
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
      <step>
        <stepName>commentForFiles</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <condition />
        <description />
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <parallel>0</parallel>
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <subprocedure>commentOnTicket</subprocedure>
        <subproject>/plugins/EC-Zendesk/project</subproject>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workspaceName />
        <actualParameters>
          <tracked>0</tracked>
          <property>
            <propertyName>comment</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>The following file have been uploaded  uploads/$[/myJob/zendesk/ticketId]/$[/myJob/zendesk/ticketId].zip
It contains:

$[/myJob/fileList]</value>
          </property>
          <property>
            <propertyName>credential</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[zendeskConfiguration]</value>
          </property>
          <property>
            <propertyName>ticketNumber</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[/myJob/zendesk/ticketId]</value>
          </property>
        </actualParameters>
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
    </procedure>
    <procedure>
      <procedureName>sub-collectServerLogs</procedureName>
      <description>A sub-procedure to collect the logs from 1 commander server</description>
      <jobNameTemplate />
      <resourceName>$[serverResource]</resourceName>
      <timeLimit />
      <timeLimitUnits>minutes</timeLimitUnits>
      <tracked>0</tracked>
      <workspaceName />
      <propertySheet>
        <tracked>0</tracked>
        <property>
          <propertyName>ec_customEditorData</propertyName>
          <tracked>0</tracked>
          <propertySheet>
            <tracked>0</tracked>
            <property>
              <propertyName>parameters</propertyName>
              <tracked>0</tracked>
              <propertySheet>
                <tracked>0</tracked>
                <property>
                  <propertyName>agents</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>destinationDirectory</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>jobNumber</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>product</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>options</propertyName>
                      <tracked>0</tracked>
                      <propertySheet>
                        <tracked>0</tracked>
                        <property>
                          <propertyName>option1</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>ElectricCommander</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>electriccommander</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option2</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>ElectricFlow</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>electricflow</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>optionCount</propertyName>
                          <counter>0</counter>
                          <expandable>1</expandable>
                          <tracked>0</tracked>
                          <value>2</value>
                        </property>
                        <property>
                          <propertyName>type</propertyName>
                          <counter>0</counter>
                          <expandable>1</expandable>
                          <tracked>0</tracked>
                          <value>list</value>
                        </property>
                      </propertySheet>
                    </property>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>serverResource</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>stepId</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>targetServerResource</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketDescription</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketTitle</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>time</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>version</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
              </propertySheet>
            </property>
          </propertySheet>
        </property>
        <property>
          <propertyName>ec_parameterForm</propertyName>
          <counter>0</counter>
          <description />
          <expandable>1</expandable>
          <tracked>0</tracked>
          <value>&lt;editor>
    &lt;formElement> 
        &lt;label>Title&lt;/label> 
        &lt;property>ticketTitle&lt;/property> 
        &lt;documentation>The title of your ticket.&lt;/documentation> 
        &lt;type>entry&lt;/type>
        &lt;required>1&lt;/required>
    &lt;/formElement> 

    &lt;formElement> 
        &lt;label>Description&lt;/label> 
        &lt;property>ticketDescription&lt;/property> 
        &lt;documentation>The full description of your ticket.&lt;/documentation> 
        &lt;type>textarea&lt;/type>
        &lt;required>1&lt;/required>
    &lt;/formElement> 

    &lt;formElement> 
        &lt;label>Product&lt;/label> 
        &lt;property>product&lt;/property> 
        &lt;documentation>The name of the product with which you have an issue.&lt;/documentation> 
        &lt;type>select&lt;/type> 
        &lt;option> 
            &lt;name>ElectricCommander&lt;/name> 
            &lt;value>electriccommander&lt;/value> 
        &lt;/option> 
        &lt;option> 
            &lt;name>ElectricFlow&lt;/name> 
            &lt;value>electricflow&lt;/value> 
        &lt;/option> 
        &lt;value>electriccommander&lt;/value> 
        &lt;required>1&lt;/required>
    &lt;/formElement> 

    &lt;formElement> 
        &lt;label>Product Version&lt;/label> 
        &lt;property>version&lt;/property> 
        &lt;documentation>Product version.&lt;/documentation> 
        &lt;type>entry&lt;/type>
    &lt;/formElement> 


    &lt;formElement> 
        &lt;label>Agent List&lt;/label> 
        &lt;property>agents&lt;/property> 
        &lt;documentation>The comma separated list of agents where the problem occured.&lt;/documentation> 
        &lt;type>entry&lt;/type>
    &lt;/formElement> 

    &lt;formElement> 
        &lt;label>Time&lt;/label> 
        &lt;property>time&lt;/property> 
        &lt;documentation>The time at which the issue happened (if known). Format is [yyyy-mm-dd] HH:mm.&lt;/documentation> 
        &lt;type>entry&lt;/type>
    &lt;/formElement> 

    &lt;formElement> 
        &lt;label>Job Id&lt;/label> 
        &lt;property>jobNumber&lt;/property> 
        &lt;documentation>The jobId in which the issue occured (if known). It is used to retrieve the correct logs.&lt;/documentation> 
        &lt;type>entry&lt;/type>
    &lt;/formElement> 

&lt;/editor>
</value>
        </property>
      </propertySheet>
      <formalParameter>
        <formalParameterName>destinationDirectory</formalParameterName>
        <defaultValue />
        <description>Directory where to copy the logs on the target system</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>serverResource</formalParameterName>
        <defaultValue />
        <description>The name of the commander server resource to grab the  logs from</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>targetServerResource</formalParameterName>
        <defaultValue />
        <description>Name of the resource onto which to copy the logs</description>
        <expansionDeferred>0</expansionDeferred>
        <required>0</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <step>
        <stepName>grabWorkspaces</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>$[/plugins[EC-Admin]project/scripts/perlHeaderJSON]

#
# parameter
#

# Get the source workspace
my $sourceWks=getP("/resources/$[serverResource]/workspaceName");
printf("Source workspace: '%s'\n", $sourceWks);
if (($sourceWks == undef) || ($sourceWks eq "")) {
	$ec->setProperty("/myJob/sourceWorkspace", "default");
} else {
	$ec->setProperty("/myJob/sourceWorkspace", $sourceWks);
}

# Get the source workspace
my $targetWks=getP("/resources/$[targetServerResource]/workspaceName");
printf("Target workspace: '%s'\n", $targetWks);
if (($targetWks == undef) || ($targetWks eq "")) {
	$ec->setProperty("/myJob/targetWorkspace", "default");
} else {
	$ec->setProperty("/myJob/targetWorkspace", $targetWks);
}

$[/plugins[EC-Admin]project/scripts/perlLibJSON]

</command>
        <condition />
        <description>grab the workspace value
 - not defined: default
 - empty: default
 -else: pass the value</description>
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <logFileName />
        <parallel>0</parallel>
        <postProcessor />
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <shell>ec-perl</shell>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workingDirectory />
        <workspaceName />
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
      <step>
        <stepName>copyCommander_log</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <condition />
        <description />
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <parallel>0</parallel>
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName>$[serverResource]</resourceName>
        <subprocedure>Remote Copy - Native</subprocedure>
        <subproject>/plugins/EC-FileOps/project</subproject>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workspaceName />
        <actualParameters>
          <tracked>0</tracked>
          <property>
            <propertyName>destinationFile</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[destinationDirectory]/servers/$[serverResource]/</value>
          </property>
          <property>
            <propertyName>destinationResourceName</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[targetServerResource]</value>
          </property>
          <property>
            <propertyName>destinationWorkspaceName</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[/myJob/targetWorkspace]</value>
          </property>
          <property>
            <propertyName>sourceFile</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[/server/Electric Cloud/dataDirectory]/logs/*commander.log</value>
          </property>
          <property>
            <propertyName>sourceResourceName</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[serverResource]</value>
          </property>
          <property>
            <propertyName>sourceWorkspaceName</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>$[/myJob/sourceWorkspace]</value>
          </property>
        </actualParameters>
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
      <step>
        <stepName>collectTimeBasedLogs</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>#############################################################################
#
# Copyright Electric-Cloud 2015
#
#############################################################################
use Time::Local;
use Cwd;

$[/plugins[EC-Admin]project/scripts/perlHeaderJSON]

#############################################################################
#
# Parameters
#
#############################################################################
my $timeString = "$[time]";
my $serverResource = '$[serverResource]';	# name of the remote Server

#############################################################################
#
# Global Variables
#
#############################################################################
my $DEBUG=1;
my $logDir="$[/server/Electric Cloud/dataDirectory]/logs";
my $cwd= getcwd();

my $serverEpochTime=convertTimeToEpoch($timeString);

opendir(LOG, $logDir) or die("Cannot open the log directory\n$!");

while (my $file = readdir(LOG)) {
    next if ($file !~ m/commander[\-\d.]*.log.zip/);
    # printf("Processing $file\n") if ($DEBUG);
    my $fileModificationTime = (stat("$logDir/$file"))[9];      # get modification time
    # printf("    time: %d\n", $fileModificationTime);
    if ($fileModificationTime >= $serverEpochTime) {
    	$ec->createJobStep({
        	subproject   => "/plugins/EC-FileOps/project",
            subprocedure => "Remote Copy - Native",
            jobStepName  => "Copy $file",
            actualParameter => [
            	{actualParameterName => 'sourceFile',        
                               value => "$logDir/$file"},
            	{actualParameterName => 'sourceResourceName',   
                               value => "$serverResource"},
            	{actualParameterName => 'sourceWorkspaceName',   
                               value => "$[/myJob/sourceWorkspace]"},    
                                    
                {actualParameterName => 'destinationFile',         
                               value => "$[destinationDirectory]/servers/$serverResource/"},
            	{actualParameterName => 'destinationResourceName', 
                               value => "$[targetServerResource]"},
            	{actualParameterName => 'destinationWorkspaceName',   
                               value => "$[/myJob/targetWorkspace]"},            	
            ],
        });
    }
}
closedir(LOG);


#############################################################################
#
# convertTime
# Time is of format 'MM/DD/YYYY 11:35:00' or 11:35:00 or 11:35
#############################################################################
sub convertTimeToEpoch {
    my $timeStr=shift @_;
    
    # Get passed time
    my($date, $time);

    if ($timeStr =~ m/\s+/) {
        ($date, $time)=split('\s+', $timeStr);
    } else {
        $time=$timeStr;
        $date="";
    }
    my ($year, $month, $day) = split(/[.\/\-]/, $date);
    my ($hour, $min, $sec)   = split(/[:]/, $time);

    printf("Incident time (original): %s-%s-%s %s:%s\n", $year, $month, $day, $hour, $min) if ($DEBUG);

    # get server time to fill missing values
    my $localTime = "$[/timestamp MM-dd-yyyy HH:mm]";
    my ($localMonth,$localDay,$localYear,$localHour,$localMinute) = split(/[\s\-:]+/, $localTime);

    printf("Local month: $localMonth\n") if ($DEBUG);
    $year = $localYear if ($year == 0);
    $year += 2000 if ($year &lt; 100);
    $month = $localMonth if ($month == 0);
    $day   = $localDay if ($day == 0);

    printf("Incident time: %s-%s-%s %s:%s\n", $year, $month, $day, $hour, $min) if ($DEBUG);
    my $time = timelocal(0,$min,$hour,$day,$month-1,$year);

    printf("Time of the incident: %s \n", $time) if ($DEBUG);
    return $time
}

</command>
        <condition>$[/javascript "$[time]" != "" ]</condition>
        <description>Collect the logs based on a time</description>
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <logFileName />
        <parallel>0</parallel>
        <postProcessor />
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName>$[serverResource]</resourceName>
        <shell>ec-perl</shell>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workingDirectory />
        <workspaceName />
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
      <step>
        <stepName>collectJobIdBasedLogs</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>#############################################################################
#
# Copyright Electric-Cloud 2015
#
#############################################################################
use Cwd;

$[/plugins[EC-Admin]project/scripts/perlHeaderJSON]

#############################################################################
#
# Parameters
#
#############################################################################
my $jobNumber = "$[jobNumber]";
my $serverResource = "$[serverResource]";

#############################################################################
#
# Global Variables
#
#############################################################################
my $DEBUG=1;
my $logDir="$[/server/Electric Cloud/dataDirectory]/logs";
my $cwd= getcwd();

opendir(my $logD, $logDir) or die("Cannot open the log directory\n$!");

while (my $file = readdir($logD)) {
    next if ($file !~ m/commander[\-\d.]*.log.zip/);
    printf("Processing $file\n") if ($DEBUG);

my $exitCode=system("zgrep jobId=$jobNumber $logDir/$file 2>&amp;1");
    if ($exitCode == 0) {
    	printf("    Copying\n");
    	$ec->createJobStep({
        	subproject   => "/plugins/EC-FileOps/project",
            subprocedure => "Copy",
            jobStepName  => "Copy $file",
            actualParameter => [
            	{actualParameterName => 'sourceFile',        
                               value => "$logDir/$file"},
            	{actualParameterName => 'sourceResourceName',   
                               value => "$serverResource"},
            	{actualParameterName => 'sourceWorkspaceName',   
                               value => "$[/myJob/sourceWorkspace]"},    
                                    
            	{actualParameterName => 'destinationFile',         
                               value => "$[destinationDirectory]/servers/$serverResource/"},
            	{actualParameterName => 'destinationResourceName', 
                               value => "$[targetServerResource]"},
            	{actualParameterName => 'destinationWorkspaceName',   
                               	value => "$[/myJob/targetWorkspace]",            	
            ],
        });
    }
}
closedir($logD);

</command>
        <condition>$[/javascript "$[jobNumber]" != "" ]</condition>
        <description>Collect the logs based on a time</description>
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <logFileName />
        <parallel>0</parallel>
        <postProcessor />
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName>$[serverResource]</resourceName>
        <shell>ec-perl</shell>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workingDirectory />
        <workspaceName />
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
    </procedure>
  </project>
</exportedData>